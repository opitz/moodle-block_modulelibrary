{"version":3,"file":"modulelibrary.min.js","sources":["../src/modulelibrary.js"],"sourcesContent":["/**\n * AMD module for block_modulelibrary\n * @module block_modulelibrary/modulelibrary\n */\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification'],\n    function($, ajax, templates, notification) {\n\n    /**\n     * Selected template module\n     * @type {{cmid: number, name: string}|null}\n     */\n    let selectedModule = null;\n\n    /** @type {number} Current course id */\n    let currentCourseId = 0;\n\n    /**\n     * Initializes the Module Library JS.\n     * @param {Object} opts\n     */\n    const init = function(opts) {\n        opts = opts || {};\n        currentCourseId = opts.currentCourseId || 0;\n        bindEvents();\n    };\n\n    /**\n     * Bind all events for the module library UI\n     */\n    function bindEvents() {\n        // When selecting a template course.\n        $(document).on('change', '#modulelibrary-course-select', function() {\n            const courseId = $(this).val();\n            if (courseId) {\n                loadTemplateCourseSections(courseId);\n            } else {\n                $('#modulelibrary-modules').empty();\n                $('#modulelibrary-copy-form').empty();\n            }\n        });\n\n        // When clicking \"Copy this module\".\n        $(document).on('click', '.select-template-module-btn', function() {\n            selectedModule = {cmid: $(this).data('cmid'), name: $(this).data('name')};\n            showCopyForm();\n        });\n\n        // Handle copy confirmation.\n        $(document).on('submit', '#copy-assessment-form', function(e) {\n            e.preventDefault();\n            doCopy();\n        });\n\n        // Cancel copy.\n        $(document).on('click', '#cancel-copy-btn', function() {\n            selectedModule = null;\n            $('#modulelibrary-copy-form').empty();\n        });\n    }\n\n    /**\n     * Load sections and modules from the template course.\n     * @param {number} courseId\n     */\n    function loadTemplateCourseSections(courseId) {\n        const loading = document.querySelector('#modulelibrary-loading');\n        const container = document.querySelector('#modulelibrary-modules');\n        const formContainer = document.querySelector('#modulelibrary-copy-form');\n\n        loading.style.display = 'block'; // Show a spinner.\n        container.innerHTML = '';\n        formContainer.innerHTML = '';\n\n        ajax.call([{\n            methodname: 'block_modulelibrary_get_template_course_modules',\n            args: {courseid: parseInt(courseId, 10)}\n        }])[0].done(function(response) {\n            loading.style.display = 'none'; // Hide the spinner.\n            templates.render('block_modulelibrary/modules', response)\n                .then((html, js) => {\n                    templates.appendNodeContents(container, html, js);\n                    return null;\n                })\n                .catch(notification.exception);\n        }).fail(function(err) {\n            loading.style.display = 'none'; // Hide the spinner.\n            notification.exception(err);\n        });\n    }\n\n    /**\n     * Show copy form for selected template module\n     */\n    function showCopyForm() {\n        if (!selectedModule) {\n            return;\n        }\n\n        $('#modulelibrary-copy-form').html('<p>Loading target sections...</p>');\n\n        ajax.call([{\n            methodname: 'block_modulelibrary_get_target_course_sections',\n            args: {courseid: currentCourseId}\n        }])[0].done(function(sections) {\n            // Data to pass to the Mustache template\n            const data = {\n                modulename: selectedModule.name,\n                sections: sections\n            };\n\n            templates.render('block_modulelibrary/copy_form', data)\n                .then(function(html, js) {\n                    $('#modulelibrary-copy-form').html(html);\n                    templates.runTemplateJS(js);\n                    return null;\n                })\n                .fail(function(err) {\n                    $('#modulelibrary-copy-form').html('<p>Failed to render form</p>');\n                    notification.exception(err);\n                });\n\n        }).fail(function(err) {\n            $('#modulelibrary-copy-form').html('<p>Failed to load target sections</p>');\n            notification.exception(err);\n        });\n    }\n\n    /**\n     * Perform copy of selected template module\n     */\n    function doCopy() {\n        if (!selectedModule) {\n            notification.exception(new Error('No template module selected'));\n            return;\n        }\n        const targetsection = parseInt($('#target-section').val() || 0, 10);\n\n        ajax.call([{\n            methodname: 'block_modulelibrary_copy_activity',\n            args: {\n                cmid: parseInt(selectedModule.cmid, 10),\n                targetcourseid: currentCourseId,\n                targetsection: targetsection\n            }\n        }])[0].done(function(response) {\n            if (response.status) {\n                notification.addNotification({message: 'Module copied successfully', type: 'success'});\n                setTimeout(function() {\n                    window.location.reload();\n                    }, 1200);\n            } else {\n                notification.exception(new Error('Copy failed'));\n            }\n        }).fail(function(err) {\n            notification.exception(err);\n        });\n    }\n\n    return {init: init};\n});\n"],"names":["define","$","ajax","templates","notification","selectedModule","currentCourseId","init","opts","document","on","courseId","this","val","loading","querySelector","container","formContainer","style","display","innerHTML","call","methodname","args","courseid","parseInt","done","response","render","then","html","js","appendNodeContents","catch","exception","fail","err","loadTemplateCourseSections","empty","cmid","data","name","sections","modulename","runTemplateJS","e","preventDefault","Error","targetsection","targetcourseid","status","addNotification","message","type","setTimeout","window","location","reload","doCopy"],"mappings":"AAIAA,2CAAO,CAAC,SAAU,YAAa,iBAAkB,sBAC7C,SAASC,EAAGC,KAAMC,UAAWC,kBAMzBC,eAAiB,KAGjBC,gBAAkB,QAgJf,CAACC,KA1IK,SAASC,MAElBF,iBADAE,KAAOA,MAAQ,IACQF,iBAAmB,EAS1CL,EAAEQ,UAAUC,GAAG,SAAU,gCAAgC,iBAC/CC,SAAWV,EAAEW,MAAMC,MACrBF,kBA+BwBA,gBAC1BG,QAAUL,SAASM,cAAc,0BACjCC,UAAYP,SAASM,cAAc,0BACnCE,cAAgBR,SAASM,cAAc,4BAE7CD,QAAQI,MAAMC,QAAU,QACxBH,UAAUI,UAAY,GACtBH,cAAcG,UAAY,GAE1BlB,KAAKmB,KAAK,CAAC,CACPC,WAAY,kDACZC,KAAM,CAACC,SAAUC,SAASd,SAAU,QACpC,GAAGe,MAAK,SAASC,UACjBb,QAAQI,MAAMC,QAAU,OACxBhB,UAAUyB,OAAO,8BAA+BD,UAC3CE,MAAK,CAACC,KAAMC,MACT5B,UAAU6B,mBAAmBhB,UAAWc,KAAMC,IACvC,QAEVE,MAAM7B,aAAa8B,cACzBC,MAAK,SAASC,KACbtB,QAAQI,MAAMC,QAAU,OACxBf,aAAa8B,UAAUE,QApDnBC,CAA2B1B,WAE3BV,EAAE,0BAA0BqC,QAC5BrC,EAAE,4BAA4BqC,YAKtCrC,EAAEQ,UAAUC,GAAG,QAAS,+BAA+B,WACnDL,eAAiB,CAACkC,KAAMtC,EAAEW,MAAM4B,KAAK,QAASC,KAAMxC,EAAEW,MAAM4B,KAAK,SAmDhEnC,iBAILJ,EAAE,4BAA4B6B,KAAK,qCAEnC5B,KAAKmB,KAAK,CAAC,CACPC,WAAY,iDACZC,KAAM,CAACC,SAAUlB,oBACjB,GAAGoB,MAAK,SAASgB,gBAEXF,KAAO,CACTG,WAAYtC,eAAeoC,KAC3BC,SAAUA,UAGdvC,UAAUyB,OAAO,gCAAiCY,MAC7CX,MAAK,SAASC,KAAMC,WACjB9B,EAAE,4BAA4B6B,KAAKA,MACnC3B,UAAUyC,cAAcb,IACjB,QAEVI,MAAK,SAASC,KACXnC,EAAE,4BAA4B6B,KAAK,gCACnC1B,aAAa8B,UAAUE,WAGhCD,MAAK,SAASC,KACbnC,EAAE,4BAA4B6B,KAAK,yCACnC1B,aAAa8B,UAAUE,YA3E3BnC,EAAEQ,UAAUC,GAAG,SAAU,yBAAyB,SAASmC,GACvDA,EAAEC,gCAkFDzC,2BACDD,aAAa8B,UAAU,IAAIa,MAAM,sCAG/BC,cAAgBvB,SAASxB,EAAE,mBAAmBY,OAAS,EAAG,IAEhEX,KAAKmB,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CACFgB,KAAMd,SAASpB,eAAekC,KAAM,IACpCU,eAAgB3C,gBAChB0C,cAAeA,kBAEnB,GAAGtB,MAAK,SAASC,UACbA,SAASuB,QACT9C,aAAa+C,gBAAgB,CAACC,QAAS,6BAA8BC,KAAM,YAC3EC,YAAW,WACPC,OAAOC,SAASC,WACb,OAEPrD,aAAa8B,UAAU,IAAIa,MAAM,mBAEtCZ,MAAK,SAASC,KACbhC,aAAa8B,UAAUE,QAxGvBsB,MAIJzD,EAAEQ,UAAUC,GAAG,QAAS,oBAAoB,WACxCL,eAAiB,KACjBJ,EAAE,4BAA4BqC"}